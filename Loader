if not game:IsLoaded() then
    game.Loaded:Wait()
end
if game.PlaceId == 9476339275 and game.Players.LocalPlayer.Name ~= "ernesto133488" then
    task.wait(5)
    setfpscap(6)
    local HttpService = game:GetService("HttpService")
    local TeleportService = game:GetService("TeleportService")
    local Players = game:GetService("Players")

    local BLACKLISTED_PLAYERS = {"Luna_Duck88", "Tttttt5jrhrud", "KnightPandaBuilder20", "HunterRaven2024YT", "Ac3_V3nom2015", "XxDuckMagicxX2011", "Ne0nLucky2016", "XxCookie_GIGAXX2017", "OwenByteRift201614", "ChillPix3lat3dW0lf", "MasonPro201638", "AlphaGlitchHero", "Eagle_Toxic66", "DARK_Ven0m2017", "Luk3B3ast45", "FoxByteGiga80", "GigaHyperDragon", "RoguePixelDrift", "XxRogueHeroxX87", "StreamDriftNova", "HawkStarryPixelated1", "Olivia_Jelly201174", "BlazeC00kie2014", "VenomSilverAlpha", "LuckyChas3Mast3r", "SparklyLegend45", "Jayd3nNova86", "Nora_Max2013"}
    local CHECK_DELAY = 15 * 60
    local COOLDOWN = 5
    local PLACE_ID = game.PlaceId

    print("Script Started - Waiting for players to load...")

    repeat task.wait() until #Players:GetPlayers() > 0

    print("Players detected, starting...")

    local function getCurrentPlayers()
        local players = {}
        for _, player in ipairs(Players:GetPlayers()) do
            table.insert(players, player.Name)
        end
        return players
    end

    local function containsBlacklisted()
        local currentPlayers = getCurrentPlayers()
        print("[CHECK] Players currently in server:")
        for _, p in ipairs(currentPlayers) do
            print(" - "..p)
        end

        local hasBlacklisted = false
        local isLocalPlayerBlacklisted = false

        for _, blName in ipairs(BLACKLISTED_PLAYERS) do
            print("[CHECK] Looking for blacklist name:", blName)
            for _, playerName in ipairs(currentPlayers) do
                if playerName == blName then
                    if playerName == Players.LocalPlayer.Name then
                        isLocalPlayerBlacklisted = true
                    else
                        hasBlacklisted = true
                    end
                end
            end
        end

        print("[RESULT] Blacklisted check - LocalPlayer blacklisted:", isLocalPlayerBlacklisted, "Other blacklisted:", hasBlacklisted)
        
        return hasBlacklisted, isLocalPlayerBlacklisted
    end

    local function fetchValidServers()
        local servers = {}
        local url = "https://games.roblox.com/v1/games/"..PLACE_ID.."/servers/Public?sortOrder=Desc&limit=100"
        
        local response = request({
            Url = url,
            Method = "GET"
        })
        
        if response.StatusCode == 200 then
            local data = HttpService:JSONDecode(response.Body)
            for _, server in ipairs(data.data) do
                if server.id ~= game.JobId and server.playing < server.maxPlayers then
                    table.insert(servers, server.id)
                end
            end
        end
        return servers
    end

    local function safeTeleport()
        local servers = fetchValidServers()
        if #servers > 0 then
            queueonteleport([[
                loadstring(game:HttpGet("https://raw.githubusercontent.com/ImNotW4CH0/DoubleDown/refs/heads/main/Loader"))()
            ]])
            TeleportService:TeleportToPlaceInstance(PLACE_ID, servers[math.random(#servers)])
        else
            warn("No valid servers found")
        end
    end

    local function main()
        local hasBlacklisted, isLocalPlayerBlacklisted = containsBlacklisted()

        if hasBlacklisted and not isLocalPlayerBlacklisted then
            print("[ACTION] Blacklisted detected - hopping...")
            task.wait(COOLDOWN)
            safeTeleport()
        elseif isLocalPlayerBlacklisted and not hasBlacklisted then
            print("[ACTION] LocalPlayer blacklisted - not hopping.")
            print("[ACTION] Safe server - waiting...")
            loadstring(game:HttpGet("https://raw.githubusercontent.com/ImNotW4CH0/DoubleDown/refs/heads/main/MainScript"))()
            task.wait(CHECK_DELAY)
            task.spawn(function()
                while true do
                    local RemoteCalls = game:GetService("ReplicatedStorage"):WaitForChild("RemoteCalls")
                    RemoteCalls:WaitForChild("DestroyRoom"):InvokeServer()
                    task.wait(0.1)
                end
            end)
            task.wait(5)
            safeTeleport()
        else
            print("[ACTION] Safe server - waiting...")
            loadstring(game:HttpGet("https://raw.githubusercontent.com/ImNotW4CH0/DoubleDown/refs/heads/main/MainScript"))()
            task.wait(CHECK_DELAY)
            task.spawn(function()
                while true do
                    local RemoteCalls = game:GetService("ReplicatedStorage"):WaitForChild("RemoteCalls")
                    RemoteCalls:WaitForChild("DestroyRoom"):InvokeServer()
                    task.wait(0.1)
                end
            end)
            task.wait(5)
            safeTeleport()
        end
    end

    main()
end
